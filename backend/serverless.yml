service: bookworm

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 29
  environment:
    BOOKS_TABLE: ${self:service}-books-table-${self:provider.stage}
    USERS_TABLE: ${self:service}-users-table-${self:provider.stage}
    BOOK_COVERS_BUCKET: ${self:service}-book-covers-bucket-${self:provider.stage}
    FRONTEND_URL: ${env:FRONTEND_URL, 'http://localhost:3000'} # ? When deployed to cloudfront ?
    CLOUDFRONT_DOMAIN: !GetAtt BookCoversDistribution.DomainName
    COGNITO_USER_POOL_ID: !Ref CognitoUserPool
    COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient
    COOKIE_DOMAIN: ${env:COOKIE_DOMAIN, 'localhost'} # ? When deployed to cloudfront ?

    # from SSM Parameter Store
    GOOGLE_CLIENT_ID: ${ssm:/bookworm/${self:provider.stage}/google-client-id}
    GOOGLE_CLIENT_SECRET: ${ssm:/bookworm/${self:provider.stage}/google-client-secret~true}
    ADMIN_EMAIL: ${ssm:/bookworm/${self:provider.stage}/admin-email}

  iam:
    # IAM role that gets attached for the Lambda functions
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Scan
            - dynamodb:Query
          Resource:
            - !GetAtt BooksTable.Arn
            - !Sub "${BooksTable.Arn}/index/*"
        # s3 permissions
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:HeadObject
          Resource:
            - !Sub "${BookCoversBucket.Arn}/*"
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - !GetAtt BookCoversBucket.Arn

        # Cognito permissions
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
          Resource:
            - !GetAtt CognitoUserPool.Arn

        # SSM Parameter Store permissions
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource:
            - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/bookworm/${self:provider.stage}/*"

        # KMS permissions for decrypting SecureString parameters
        - Effect: Allow
          Action:
            - kms:Decrypt
          Resource:
            - !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*"
          Condition:
            StringEquals:
              kms:ViaService:
                - !Sub "ssm.${AWS::Region}.amazonaws.com"

functions:
  # Auth Related Endpoints
  authCallback:
    handler: src/handlers/auth/callback.handler
    description: Handle OAuth callback and create session
    events:
      - http:
          method: post
          path: /auth/callback
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  authLogout:
    handler: src/handlers/auth/logout.handler
    description: Logout and clear session
    events:
      - http:
          method: post
          path: /auth/logout
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  authRefresh:
    handler: src/handlers/auth/refresh.handler
    description: Refresh access token
    events:
      - http:
          method: post
          path: /auth/refresh
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  # User Profile Endpoints
  getUserProfile:
    handler: src/handlers/users/getProfile.handler
    description: Get current user profile
    events:
      - http:
          method: get
          path: /users/me
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  updateUserProfile:
    handler: src/handlers/users/updateProfile.handler
    description: Update user profile
    events:
      - http:
          method: patch
          path: /users/me
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  # Book Related Endpoints
  getAllBooks:
    handler: src/handlers/books/getAllBooks.handler
    description: Get all books
    events:
      - http:
          method: get
          path: /books
          cors: # makes API Gateway return the CORS response headers
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  getBookById:
    handler: src/handlers/books/getBookById.handler
    description: Get a book by ID
    events:
      - http:
          method: get
          path: /books/{id}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  createBook:
    handler: src/handlers/books/createBook.handler
    description: Create a new book - ADMIN
    events:
      - http:
          method: post
          path: /books
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  deleteBook:
    handler: src/handlers/books/deleteBook.handler
    description: Delete a  book - ADMIN
    events:
      - http:
          method: delete
          path: /books/{id}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  generateUploadUrl:
    handler: src/handlers/books/generateUploadUrl.handler
    description: Generate presigned URL for uploading book cover - ADMIN
    events:
      - http:
          method: post
          path: /books/{id}/upload-url
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  updateBook:
    handler: src/handlers/books/updateBook.handler
    description: "Update a book - ADMIN"
    events:
      - http:
          method: put
          path: /books/{id}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

resources:
  Resources:
    # Cognito User Pool - central user directory
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-user-pool-${self:provider.stage}
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: false
          - Name: name
            AttributeDataType: String
            Required: false
            Mutable: true
          - Name: picture
            AttributeDataType: String
            Required: false
            Mutable: true
        UserAttributeUpdateSettings:
          AttributesRequireVerificationBeforeUpdate:
            - email

    # Cognito User Pool Client
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      DependsOn: CognitoIdentityProviderGoogle
      Properties:
        ClientName: ${self:service}-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        SupportedIdentityProviders:
          - Google
        AllowedOAuthFlows:
          - code
        AllowedOAuthScopes:
          - email
          - openid
          - profile
        AllowedOAuthFlowsUserPoolClient: true
        CallbackURLs:
          - ${self:provider.environment.FRONTEND_URL}/auth/callback
          - http://localhost:3000/auth/callback
        LogoutURLs:
          - ${self:provider.environment.FRONTEND_URL}
          - http://localhost:3000
        PreventUserExistenceErrors: ENABLED
        RefreshTokenValidity: 7
        AccessTokenValidity: 60
        IdTokenValidity: 60
        TokenValidityUnits:
          RefreshToken: days
          AccessToken: minutes
          IdToken: minutes

    # Cognito User Pool Domain
    CognitoUserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      Properties:
        Domain: ${self:service}-${self:provider.stage}-${sls:instanceId}
        UserPoolId: !Ref CognitoUserPool

    # Google Identity Provider
    CognitoIdentityProviderGoogle:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId: !Ref CognitoUserPool
        ProviderName: Google
        ProviderType: Google
        ProviderDetails:
          client_id: ${ssm:/bookworm/${self:provider.stage}/google-client-id}
          client_secret: ${ssm:/bookworm/${self:provider.stage}/google-client-secret~true}
          authorize_scopes: "email openid profile"
        AttributeMapping:
          email: email
          name: name
          picture: picture
          username: sub

    # DynamoDB Tables
    BooksTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.BOOKS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: "S"
          - AttributeName: category
            AttributeType: "S"
          - AttributeName: updatedAt
            AttributeType: "S"
          - AttributeName: price
            AttributeType: "N"
          - AttributeName: entityType
            AttributeType: "S"
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          # GSI for all books sorted by updatedAt
          - IndexName: entityType-updatedAt-index
            KeySchema:
              - AttributeName: entityType
                KeyType: HASH
              - AttributeName: updatedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for all books sorted by price
          - IndexName: entityType-price-index
            KeySchema:
              - AttributeName: entityType
                KeyType: HASH
              - AttributeName: price
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for querying books by category and sorting by updatedAt
          - IndexName: category-updatedAt-index
            KeySchema:
              - AttributeName: category
                KeyType: HASH
              - AttributeName: updatedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for querying books by category and sorting by price
          - IndexName: category-price-index
            KeySchema:
              - AttributeName: category
                KeyType: HASH
              - AttributeName: price
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # S3 Bucket for Book Cover Images
    BookCoversBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.BOOK_COVERS_BUCKET}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - HEAD
              AllowedOrigins:
                - "*"
              MaxAge: 3000
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    BookCoversDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          Comment: "CDN for ${self:service} book covers - ${self:provider.stage}"
          Origins:
            - Id: S3Origin
              DomainName: !GetAtt BookCoversBucket.RegionalDomainName #  tells CloudFront that the source of the files is the regional domain name of the BookCoversBucket
              S3OriginConfig:
                OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
          DefaultCacheBehavior:
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
              Headers:
                - Origin
                - Access-Control-Request-Method
                - Access-Control-Request-Headers
            Compress: true
            MinTTL: 0
            DefaultTTL: 604800 # 7 days - tells CloudFront to keep a copy of the image in its cache
            MaxTTL: 31536000 # 1 year
          ViewerCertificate:
            CloudFrontDefaultCertificate: true
          HttpVersion: http2and3
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    CloudFrontOriginAccessIdentity: # By creating an OAI, we are creating a principal that can be granted permission to access the S3 bucket.
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "OAI for ${self:service} book covers bucket"

    BookCoversBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref BookCoversBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
              Action:
                - s3:GetObject # Grants CloudFront permission to read objects in the bucket
              Resource: !Sub "${BookCoversBucket.Arn}/*"

  Outputs:
    CognitoUserPoolId:
      Value: !Ref CognitoUserPool
      Export:
        Name: ${self:service}-${self:provider.stage}-UserPoolId

    CognitoUserPoolClientId:
      Value: !Ref CognitoUserPoolClient
      Export:
        Name: ${self:service}-${self:provider.stage}-UserPoolClientId

    CognitoUserPoolDomain:
      Value: !Sub "https://${CognitoUserPoolDomain}.auth.${self:provider.region}.amazoncognito.com"
      Export:
        Name: ${self:service}-${self:provider.stage}-UserPoolDomain
