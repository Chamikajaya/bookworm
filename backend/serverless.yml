service: bookworm

package:
  exclude:
    - templates/**
    - scripts/**
    - .gitignore

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 29
  environment:
    BOOKS_TABLE: ${self:service}-books-table-${self:provider.stage}
    USERS_TABLE: ${self:service}-users-table-${self:provider.stage}
    CART_TABLE: ${self:service}-cart-table-${self:provider.stage}
    ORDERS_TABLE: ${self:service}-orders-table-${self:provider.stage}
    ORDER_ITEMS_TABLE: ${self:service}-order-items-table-${self:provider.stage}
    BOOK_COVERS_BUCKET: ${self:service}-book-covers-bucket-${self:provider.stage}
    FRONTEND_URL: ${env:FRONTEND_URL, 'https://localhost:3000'}
    CLOUDFRONT_DOMAIN: !GetAtt BookCoversDistribution.DomainName
    COGNITO_USER_POOL_ID: !Ref CognitoUserPool
    COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient
    STAGE: ${self:provider.stage}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1 # to improve performance and reducing latency of lambdas when calling aws services , effective if using aws sdk v2
    SES_FROM_EMAIL: ${env:SES_FROM_EMAIL, 'chamika@nexvibe.ai'} # ! TODO: Need to verify this email in SES
    EMAIL_QUEUE_URL: !Ref EmailQueue
    EMAIL_TEMPLATE_BUCKET: ${self:service}-email-templates-bucket-${self:provider.stage}
    COGNITO_DOMAIN:
      Fn::Sub:
        - "https://${Domain}.auth.${AWS::Region}.amazoncognito.com"
        - Domain: bookworm-shop-${self:provider.stage}

  iam:
    # IAM role that gets attached for the Lambda functions
    role:
      statements:
        # Book Table permissions
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Scan
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt BooksTable.Arn
            - !Sub "${BooksTable.Arn}/index/*"
            - !GetAtt UsersTable.Arn
            - !Sub "${UsersTable.Arn}/index/*"
            - !GetAtt CartTable.Arn
            - !Sub "${CartTable.Arn}/index/*"
            - !GetAtt OrdersTable.Arn
            - !Sub "${OrdersTable.Arn}/index/*"
            - !GetAtt OrderItemsTable.Arn
            - !Sub "${OrderItemsTable.Arn}/index/*"

        # s3 permissions
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:HeadObject
          Resource:
            - !Sub "${BookCoversBucket.Arn}/*"
            - "arn:aws:s3:::bookworm-email-templates-bucket-dev/*"
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - !GetAtt BookCoversBucket.Arn
            - !Sub "arn:aws:s3:::bookworm-email-templates-bucket-dev"

        # Cognito permissions
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
          Resource:
            - !GetAtt CognitoUserPool.Arn

        # AWS Secrets Manager permissions
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource:
            - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:bookworm/${self:provider.stage}/*"

        # SQS permissions
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - !GetAtt EmailQueue.Arn

        # SES permissions
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"

functions:
  # Auth Related Endpoints
  authCallback: # function for getting cookies after OAuth callback
    handler: src/handlers/auth/callback.handler
    description: Handle OAuth callback and create session
    events:
      - http:
          method: post
          path: /auth/callback
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  authLogout:
    handler: src/handlers/auth/logout.handler
    description: Logout and clear session
    events:
      - http:
          method: post
          path: /auth/logout
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  authRefresh:
    handler: src/handlers/auth/refresh.handler
    description: Refresh access token
    events:
      - http:
          method: post
          path: /auth/refresh
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  # User Profile Endpoints
  getUserProfile:
    handler: src/handlers/users/getProfile.handler
    description: Get current user profile
    events:
      - http:
          method: get
          path: /users/me
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  updateUserProfile:
    handler: src/handlers/users/updateUserProfile.handler
    description: Update user profile
    events:
      - http:
          method: patch
          path: /users/me
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  # Book Related Endpoints
  getAllBooks:
    handler: src/handlers/books/getAllBooks.handler
    description: Get all books
    events:
      - http:
          method: get
          path: /books
          cors: # makes API Gateway return the CORS response headers
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  getBookById:
    handler: src/handlers/books/getBookById.handler
    description: Get a book by ID
    events:
      - http:
          method: get
          path: /books/{id}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  createBook:
    handler: src/handlers/books/createBook.handler
    description: Create a new book - ADMIN
    events:
      - http:
          method: post
          path: /books
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  deleteBook:
    handler: src/handlers/books/deleteBook.handler
    description: Delete a  book - ADMIN
    events:
      - http:
          method: delete
          path: /books/{id}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  generateUploadUrl:
    handler: src/handlers/books/generateUploadUrl.handler
    description: Generate presigned URL for uploading book cover - ADMIN
    events:
      - http:
          method: post
          path: /books/{id}/upload-url
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  updateBook:
    handler: src/handlers/books/updateBook.handler
    description: "Update a book - ADMIN"
    events:
      - http:
          method: put
          path: /books/{id}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  # Cart Related Endpoints
  getCart:
    handler: src/handlers/cart/getCart.handler
    description: Get current user's cart
    events:
      - http:
          method: get
          path: /cart
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  addToCart:
    handler: src/handlers/cart/addToCart.handler
    description: Add item to cart
    events:
      - http:
          method: post
          path: /cart
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  updateCartItem:
    handler: src/handlers/cart/updateCartItem.handler
    description: Update item quantity in cart
    events:
      - http:
          method: patch
          path: /cart/{bookId}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  removeFromCart:
    handler: src/handlers/cart/removeFromCart.handler
    description: Remove item from cart
    events:
      - http:
          method: delete
          path: /cart/{bookId}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  clearCart:
    handler: src/handlers/cart/clearCart.handler
    description: Clear the cart
    events:
      - http:
          method: delete
          path: /cart
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  # Order Related Endpoints
  createOrder:
    handler: src/handlers/orders/createOrder.handler
    description: Create an order from cart
    events:
      - http:
          method: post
          path: /orders
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  updateOrderStatus:
    handler: src/handlers/orders/updateOrderStatus.handler
    description: Update order status - ADMIN
    events:
      - http:
          method: patch
          path: /orders/{orderId}/status
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  getOrders:
    handler: src/handlers/orders/getOrdersByUser.handler
    description: Get all orders for current user
    events:
      - http:
          method: get
          path: /orders
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  getOrderById:
    handler: src/handlers/orders/getOrderById.handler
    description: Get order by ID
    events:
      - http:
          method: get
          path: /orders/{orderId}
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  getAllOrders:
    handler: src/handlers/orders/getAllOrders.handler
    description: Get all orders - ADMIN
    events:
      - http:
          method: get
          path: /orders
          cors:
            origin: ${self:provider.environment.FRONTEND_URL}
            allowCredentials: true

  # * Email Processing - SQS
  processEmailQueue:
    handler: src/handlers/emails/processEmailQueue.handler
    description: Process email queue
    events:
      - sqs:
          arn: !GetAtt EmailQueue.Arn
          # * Lambda function will be invoked as soon as the first of the following 2 conditions is met
          batchSize: 10 # try to collect up to 10 messages before invoking the function
          maximumBatchingWindow: 5 # After you receive the first message for a new batch, do not wait longer than 5 seconds to invoke Lambda function, even if the batch isn't full yet
          functionResponseType: ReportBatchItemFailures # if a message fails to process, it will be retried - lambda function will not throw the error itself, but will return the list of failed messages to SQS

resources:
  Resources:
    # Cognito User Pool - central user directory
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-user-pool-${self:provider.stage}
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: true

    # Cognito User Pool Client
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      DependsOn: CognitoIdentityProviderGoogle
      Properties:
        ClientName: ${self:service}-client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_REFRESH_TOKEN_AUTH
        SupportedIdentityProviders:
          - Google
        AllowedOAuthFlows:
          - code
        AllowedOAuthScopes:
          - email
          - openid
          - profile
        AllowedOAuthFlowsUserPoolClient: true
        CallbackURLs:
          - ${self:provider.environment.FRONTEND_URL}/auth/callback
          - http://localhost:3000/auth/callback
        LogoutURLs:
          - ${self:provider.environment.FRONTEND_URL}
          - http://localhost:3000
        PreventUserExistenceErrors: ENABLED
        RefreshTokenValidity: 7 # days
        AccessTokenValidity: 60 # minutes
        IdTokenValidity: 60 # minutes
        TokenValidityUnits:
          RefreshToken: days
          AccessToken: minutes
          IdToken: minutes

    # Cognito User Pool Domain
    CognitoUserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      DependsOn:
        - CognitoUserPool
        - CognitoUserPoolClient
      Properties:
        Domain: bookworm-shop-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool

    # Google Identity Provider - connects Cognito to Google OAuth
    CognitoIdentityProviderGoogle:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId: !Ref CognitoUserPool
        ProviderName: Google
        ProviderType: Google
        ProviderDetails:
          # Secrets are stored in AWS Secrets Manager
          client_id: !Sub "{{resolve:secretsmanager:bookworm/${self:provider.stage}/google-oauth:SecretString:client_id}}"
          client_secret: !Sub "{{resolve:secretsmanager:bookworm/${self:provider.stage}/google-oauth:SecretString:client_secret}}"
          authorize_scopes: "email openid profile"
        AttributeMapping:
          email: email
          name: name
          picture: picture
          username: sub

    # DynamoDB Tables
    BooksTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.BOOKS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: "S"
          - AttributeName: category
            AttributeType: "S"
          - AttributeName: updatedAt
            AttributeType: "S"
          - AttributeName: price
            AttributeType: "N"
          - AttributeName: entityType
            AttributeType: "S"
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          # GSI for all books sorted by updatedAt
          - IndexName: entityType-updatedAt-index
            KeySchema:
              - AttributeName: entityType
                KeyType: HASH
              - AttributeName: updatedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for all books sorted by price
          - IndexName: entityType-price-index
            KeySchema:
              - AttributeName: entityType
                KeyType: HASH
              - AttributeName: price
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for querying books by category and sorting by updatedAt
          - IndexName: category-updatedAt-index
            KeySchema:
              - AttributeName: category
                KeyType: HASH
              - AttributeName: updatedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for querying books by category and sorting by price
          - IndexName: category-price-index
            KeySchema:
              - AttributeName: category
                KeyType: HASH
              - AttributeName: price
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: email-index
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    CartTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.CART_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: bookId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: bookId
            KeyType: RANGE
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: orderId
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: orderId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: userId-createdAt-index
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: status-createdAt-index
            KeySchema:
              - AttributeName: status
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    OrderItemsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDER_ITEMS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: orderId
            AttributeType: S
          - AttributeName: bookId
            AttributeType: S
        KeySchema:
          - AttributeName: orderId
            KeyType: HASH
          - AttributeName: bookId
            KeyType: RANGE
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # SQS Queue for email processing
    # Standard queue type not FIFO type
    EmailQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-email-queue-${self:provider.stage}
        VisibilityTimeout: 300 # 5 minutes -  When a consumer receives a message from an SQS queue, the visibility timeout for that specific message begins. During this period, the message remains in the queue but is made invisible to other consumers.
        MessageRetentionPeriod: 86400 # 1 day in seconds
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt EmailDeadLetterQueue.Arn
          maxReceiveCount: 3 # if a message fails to process 3 times, it will be sent to the dead letter queue
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # dead letter queue for emails which failed to process
    EmailDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-email-dead-letter-queue-${self:provider.stage}
        MessageRetentionPeriod: 1209600 # 14 days in seconds
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # S3 Bucket for Book Cover Images
    BookCoversBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.BOOK_COVERS_BUCKET}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - HEAD
              AllowedOrigins:
                - "*"
              MaxAge: 3000
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    BookCoversDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          Comment: "CDN for ${self:service} book covers - ${self:provider.stage}"
          Origins:
            - Id: S3Origin
              DomainName: !GetAtt BookCoversBucket.RegionalDomainName #  tells CloudFront that the source of the files is the regional domain name of the BookCoversBucket
              S3OriginConfig:
                OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
          DefaultCacheBehavior:
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
              Headers:
                - Origin
                - Access-Control-Request-Method
                - Access-Control-Request-Headers
            Compress: true
            MinTTL: 0
            DefaultTTL: 604800 # 7 days - tells CloudFront to keep a copy of the image in its cache
            MaxTTL: 31536000 # 1 year
          ViewerCertificate:
            CloudFrontDefaultCertificate: true
          HttpVersion: http2and3
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    CloudFrontOriginAccessIdentity: # By creating an OAI, we are creating a principal that can be granted permission to access the S3 bucket.
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "OAI for ${self:service} book covers bucket"

    BookCoversBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref BookCoversBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
              Action:
                - s3:GetObject # Grants CloudFront permission to read objects in the bucket
              Resource: !Sub "${BookCoversBucket.Arn}/*"
