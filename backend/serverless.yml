service: bookworm

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 29
  environment:
    BOOKS_TABLE: ${self:service}-books-table-${self:provider.stage}
    BOOK_COVERS_BUCKET: ${self:service}-book-covers-bucket-${self:provider.stage}
    # # ! TODO:
    FRONTEND_URL: ${env:FRONTEND_URL, 'https://d28jacfojat6xy.cloudfront.net'} # https://d28jacfojat6xy.cloudfront.net
    CLOUDFRONT_DOMAIN: !GetAtt BookCoversDistribution.DomainName

  iam:
    role: # IAM role that gets attached for the Lambda functions
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Scan
            - dynamodb:Query
          Resource:
            - !GetAtt BooksTable.Arn
            - !Sub "${BooksTable.Arn}/index/*"
        # s3 permissions
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:HeadObject
          Resource:
            - !Sub "${BookCoversBucket.Arn}/*"
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - !GetAtt BookCoversBucket.Arn

functions:
  # Book Related Endpoints
  getAllBooks:
    handler: src/handlers/books/getAllBooks.handler
    description: Get all books
    events:
      - http:
          method: get
          path: /books
          cors: true # makes API Gateway return the CORS response headers

  getBookById:
    handler: src/handlers/books/getBookById.handler
    description: Get a book by ID
    events:
      - http:
          method: get
          path: /books/{id}
          cors: true

  createBook:
    handler: src/handlers/books/createBook.handler
    description: Create a new book - ADMIN
    events:
      - http:
          method: post
          path: /books
          cors: true # ! TODO: For now cors is true, later change to specific domain

  deleteBook:
    handler: src/handlers/books/deleteBook.handler
    description: Delete a  book - ADMIN
    events:
      - http:
          method: delete
          path: /books/{id}
          cors: true # ! TODO: For now cors is true, later change to specific domain

  generateUploadUrl:
    handler: src/handlers/books/generateUploadUrl.handler
    description: Generate presigned URL for uploading book cover - ADMIN
    events:
      - http:
          method: post
          path: /books/{id}/upload-url
          cors: true # ! TODO: For now cors is true, later change to specific domain

  updateBook:
    handler: src/handlers/books/updateBook.handler
    description: "Update a book - ADMIN"
    events:
      - http:
          method: put
          path: /books/{id}
          cors: true # ! TODO: For now cors is true, later change to specific domain

resources:
  Resources:
    # DynamoDB Tables
    BooksTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.BOOKS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: "S"
          - AttributeName: category
            AttributeType: "S"
          - AttributeName: updatedAt
            AttributeType: "S"
          - AttributeName: price
            AttributeType: "N"
          - AttributeName: entityType
            AttributeType: "S"
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          # GSI for all books sorted by updatedAt
          - IndexName: entityType-updatedAt-index
            KeySchema:
              - AttributeName: entityType
                KeyType: HASH
              - AttributeName: updatedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for all books sorted by price
          - IndexName: entityType-price-index
            KeySchema:
              - AttributeName: entityType
                KeyType: HASH
              - AttributeName: price
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for querying books by category and sorting by updatedAt
          - IndexName: category-updatedAt-index
            KeySchema:
              - AttributeName: category
                KeyType: HASH
              - AttributeName: updatedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI for querying books by category and sorting by price
          - IndexName: category-price-index
            KeySchema:
              - AttributeName: category
                KeyType: HASH
              - AttributeName: price
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # S3 Bucket for Book Cover Images
    BookCoversBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.BOOK_COVERS_BUCKET}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - HEAD
              AllowedOrigins:
                - "*"
              MaxAge: 3000
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    BookCoversDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          Comment: "CDN for ${self:service} book covers - ${self:provider.stage}"
          Origins:
            - Id: S3Origin
              DomainName: !GetAtt BookCoversBucket.RegionalDomainName #  tells CloudFront that the source of the files is the regional domain name of the BookCoversBucket
              S3OriginConfig:
                OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
          DefaultCacheBehavior:
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
              - OPTIONS
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none
              Headers:
                - Origin
                - Access-Control-Request-Method
                - Access-Control-Request-Headers
            Compress: true
            MinTTL: 0
            DefaultTTL: 604800 # 7 days - tells CloudFront to keep a copy of the image in its cache
            MaxTTL: 31536000 # 1 year
          ViewerCertificate:
            CloudFrontDefaultCertificate: true
          HttpVersion: http2and3
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    CloudFrontOriginAccessIdentity: # By creating an OAI, we are creating a principal that can be granted permission to access the S3 bucket.
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: "OAI for ${self:service} book covers bucket"

    BookCoversBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref BookCoversBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
              Action:
                - s3:GetObject # Grants CloudFront permission to read objects in the bucket
              Resource: !Sub "${BookCoversBucket.Arn}/*"
